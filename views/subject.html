<!DOCTYPE html>
<html lang="es" data-theme="dark">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>URJConnect ‚Äî Detalles de {{subject.name}}</title>
        <meta name="description" content="Detalles de la asignatura {{subject.name}}" />
        <link href="/css/styles.css" rel="stylesheet" />
        <link rel="icon" type="image/png" href="/assets/logo.png" />
    </head>
    <body>
        <main class="app">
            <header class="app-header glass">
                <div class="brand">
                    <a href="/" class="brand-link" style="display: inline-flex; align-items: center; gap: 10px; text-decoration: none; color: inherit">
                        <div class="logo" aria-hidden="true">
                            <img src="/assets/logo.png" alt="Logo URJConnect" style="width: 100%; height: 100%; object-fit: contain" />
                        </div>
                        <div class="brand-wordmark" aria-label="URJConnect">URJConnect</div>
                    </a>
                </div>

                <div class="toolbar">
                    <button class="icon-btn" id="themeToggle" title="Cambiar tema">üåì Tema</button>
                    <div class="divider"></div>

                    <div class="profile">
                        <button class="profile-btn" id="profileButton" aria-expanded="false" aria-controls="profileMenu">
                            <div class="avatar" id="avatar">
                                <span id="avatarInitials"></span>
                            </div>
                            <span id="profileName">Tu Nombre</span>
                        </button>
                        <div class="profile-menu dropdown" id="profileMenu">
                            <button class="icon-btn" id="btnEditProfile">‚úèÔ∏è Editar perfil</button>
                            <button class="icon-btn" id="btnLogout">üö™ Cerrar sesi√≥n</button>
                        </div>
                    </div>
                </div>
            </header>

            <section class="container glass" style="padding: 18px; border-radius: 12px">
                <div style="display: flex; gap: 16px; align-items: flex-start">
                    {{#subject.icon}}
                    <div style="width: 64px; height: 64px; flex-shrink: 0; display: grid; place-items: center; border-radius: 10px; overflow: hidden; background: var(--muted-1)">
                        <img src="{{subject.icon}}" alt="Icono {{subject.name}}" style="width: 100%; height: 100%; object-fit: contain" />
                    </div>
                    {{/subject.icon}}
                    <div style="flex: 1">
                        <!-- Nombre de la asignatura -->
                        <h1 style="margin: 0 0 16px; font-size: 32px; font-weight: 700; color: var(--primary)">{{subject.name}}</h1>

                        <p style="margin: 0 0 16px; font-size: 16px"><strong>Cr√©ditos:</strong> {{subject.credits}}</p>
                        <p style="margin: 0 0 16px; font-size: 16px"><strong>Profesor:</strong> {{subject.professor}}</p>
                        <p style="margin: 0 0 16px; font-size: 16px"><strong>Horario:</strong> {{subject.schedule}}</p>

                        <!-- Descripci√≥n detallada -->
                        <p style="font-size: 16px; line-height: 1.6"><strong>Descripci√≥n detallada:</strong></p>
                        <p style="font-size: 16px">{{subject.description}}</p>
                    </div>
                </div>

                <div class="cta" style="margin-top: 18px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center">
                    <button class="link forum-btn" id="backBtn" type="button" aria-label="Volver al inicio" onclick="window.location.href='/'">Volver al inicio</button>
                    <button class="enter" onclick="window.location.href='/subject/{{subject.id}}/forum'">
                        Entrar al foro
                    </button>
                    <!-- NUEVO: bot√≥n para abrir editor de asignatura (solo visible a admins/profesores) -->                    
                    <button class="btn" id="editSubjectBtn" type="button" aria-haspopup="dialog" aria-controls="editSubjectModal" style="display: none;">Editar asignatura</button>
                    <button class="btn secondary" id="manageStudentsBtn" type="button" style="display: none;">Alumnos</button>
                </div>
            </section>
        </main>

        <!-- Modal de editar perfil -->
        <div class="modal" id="profileModal" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
            <div class="content glass">
                <div class="body">
                    <h3 id="profileTitle" style="margin: 0 0 8px 0">Editar perfil</h3>
                    <small class="hint">Actualiza tu nombre, color de avatar y una breve bio.</small>
                    <div class="field" style="margin-top: 12px">
                        <label for="p_name">Nombre</label>
                        <input id="p_name" type="text" placeholder="Tu nombre" style="width: 100%; max-width: 420px" />
                    </div>
                    <div class="field" style="margin-top: 10px">
                        <label for="p_color">Color del avatar</label>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px">
                            <div class="swatches" id="p_swatches" aria-hidden="true"></div>
                            <input id="p_color" type="color" value="#6366f1" aria-label="Color personalizado" />
                        </div>
                        <small class="hint">Elige un color para tu avatar o usa uno de los swatches.</small>
                    </div>
                    <div class="field">
                        <label for="p_bio">Bio</label>
                        <textarea id="p_bio" rows="3" placeholder="Cu√©ntanos algo breve sobre ti..."></textarea>
                    </div>
                    <div>
                        <small class="hint" style="margin: 0 0 8px 0">Configuraci√≥n de la cuenta</small>
                    </div>
                    <div>
                        <button class="btn" id="changePasswordbtn" style="margin-top: 10px">Cambiar contrase√±a</button>
                    </div>
                    <div class="actions" style="justify-content: flex-end">
                        <button class="btn" id="saveProfile">Guardar cambios</button>
                        <button class="btn secondary" data-close="#profileModal">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Editar asignatura -->
        <div class="modal" id="editSubjectModal" role="dialog" aria-modal="true" aria-labelledby="editSubjectTitle" style="display: none">
            <div class="content glass">
                <div class="head" style="display: flex; justify-content: space-between; align-items: center; gap: 12px">
                    <h3 id="editSubjectTitle" style="margin: 0">Editar asignatura</h3>
                    <button class="close" data-close="#editSubjectModal">Cerrar</button>
                </div>
                <div class="body" style="display: flex; flex-direction: column; gap: 12px">
                    <form id="editSubjectForm" enctype="multipart/form-data">
                        <input type="hidden" id="es_id" name="id" value="{{subject.id}}" />
                        <div class="field form-label">
                            <label for="es_name">Nombre</label>
                            <input id="es_name" name="name" type="text" placeholder="Nombre visible" />
                        </div>
                        <div class="field">
                            <label for="es_desc">Descripci√≥n corta</label>
                            <textarea id="es_desc" name="desc" rows="2" placeholder="Resumen corto"></textarea>
                        </div>
                        <div class="field">
                            <label for="es_long">Descripci√≥n larga</label>
                            <textarea id="es_long" name="description" rows="3" placeholder="Descripci√≥n detallada"></textarea>
                        </div>
                        <div class="row" style="display: flex; gap: 12px">
                            <div class="field" style="flex: 1">
                                <label for="es_credits">Cr√©ditos</label>
                                <input id="es_credits" name="credits" type="number" min="0" />
                            </div>
                            <div class="field" style="flex: 1">
                                <label for="es_prof">Profesor</label>
                                <input id="es_prof" name="professor" type="text" />
                            </div>
                        </div>
                        <div class="field">
                            <label for="es_sched">Horario</label>
                            <input id="es_sched" name="schedule" type="text" placeholder="Lunes 10:00-12:00" />
                        </div>
                        <div class="field">
                            <label>Color</label>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px">
                                <div class="swatches" id="es_swatches" aria-hidden="true"></div>
                                <input id="es_color" name="color" type="color" value="#6366f1" aria-label="Color personalizado" />
                            </div>
                            <small class="hint">Elige uno de los colores o usa el selector.</small>
                        </div>
                        <div class="field">
                            <label for="es_iconFile">Icono (opcional)</label>
                            <input id="es_iconFile" name="iconFile" type="file" accept="image/*" />
                            <div id="es_currentIcon" style="margin-top:8px"></div>
                        </div>

                        <div class="actions" style="justify-content: flex-end; gap: 8px; margin-top: 6px">
                            <button class="btn secondary" type="button" data-close="#editSubjectModal">Descartar</button>
                            <button class="btn" type="submit" id="saveSubjectBtn">Guardar cambios</button>
                        </div>
                        <div class="error" id="editSubjectError" role="alert" aria-live="assertive"></div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal" id="studentsModal" role="dialog" aria-modal="true">
            <div class="content glass">
                <div class="head" style="display:flex;justify-content:space-between;">
                    <h3>Gestionar Alumnos</h3>
                    <button class="close" data-close="#studentsModal">‚úï</button>
                </div>
                <div class="body">
                    <div class="field" style="display:flex; gap:10px;">
                        <input type="email" id="newStudentEmail" placeholder="Email del alumno" style="flex:1;">
                        <button class="btn" id="btnAddStudent">A√±adir</button>
                    </div>
                    <div style="margin-top:15px; max-height:300px; overflow-y:auto;">
                        <ul id="studentsList" style="list-style:none; padding:0;"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toast" role="status" aria-live="polite"></div>

        <!-- Inyectar jsonUser (igual que en forum.html) -->
        {{#jsonUser}}
        <script id="__initialUser" type="application/json">
            {{{jsonUser}}}
        </script>
        {{/jsonUser}}

        <script>
            (function(){
                const s = document.getElementById('__initialUser');
                if (!s) return;
                try {
                    const user = JSON.parse(s.textContent || s.innerText || '{}');
                    // Cargar subject desde el servidor para verificar si es profesor
                    const subjectId = location.pathname.match(/\/subject\/([^/]+)/)?.[1];
                    if (!subjectId || !user.email) return;
                    
                    fetch(`/api/subjects/${encodeURIComponent(subjectId)}`)
                        .then(r => r.json())
                        .then(subject => {
                            console.log('Subject data:', subject);
                            console.log('User email:', user.email);
                            
                            // Verificar si es admin global o profesor
                            const isAdmin = user?.role === 'admin';
                            const professors = subject.professors || subject.professor;
                            const isProfessor = Array.isArray(professors) 
                                ? professors.includes(user.email)
                                : professors === user.email;

                            console.log('isAdmin:', isAdmin, 'isProfessor:', isProfessor);

                            if (isAdmin || isProfessor) {
                                // Mostrar bot√≥n de editar
                                const editBtn = document.getElementById('editSubjectBtn');
                                if (editBtn) {
                                    editBtn.removeAttribute('style');
                                    editBtn.style.display = 'inline-block';
                                    console.log('Button shown');
                                }
                                // Mostrar bot√≥n de gestionar alumnos
                                const manageBtn = document.getElementById('manageStudentsBtn');
                                if (manageBtn) {
                                    manageBtn.removeAttribute('style');
                                    manageBtn.style.display = 'inline-block';
                                }
                            }
                        })
                        .catch(err => console.error('Error fetching subject:', err));
                } catch (e) {
                    console.error('Parse error:', e);
                }
            })();
        </script>

        <script src="/app.js"></script>
        <script>
            // Mostrar bot√≥n de editar asignatura si el usuario es profesor o admin
            const editSubjectBtn = document.getElementById("editSubjectBtn");
            if (editSubjectBtn && isSubjectAdmin(this.user, this.subject)) {
                editSubjectBtn.style.display = "inline-block";
            }
        </script>
        <script>
        (function(){
            // Elementos del DOM
            const editBtn = document.getElementById('editSubjectBtn');
            const modal = document.getElementById('editSubjectModal');
            const closeButtons = modal ? modal.querySelectorAll('[data-close]') : [];
            const form = document.getElementById('editSubjectForm');
            const errorEl = document.getElementById('editSubjectError');
            const subjectId = '{{subject.id}}';
            const apiUrl = '/api/subjects/' + encodeURIComponent(subjectId);
            const currentIconWrap = document.getElementById('es_currentIcon');
            const iconFileInput = document.getElementById('es_iconFile');

            let currentIconPath = null;

            function openModal(){ 
                if(modal) modal.style.display = 'block'; 
                if(errorEl) errorEl.textContent = ''; 
            }
            
            function closeModal(){ 
                if(modal) modal.style.display = 'none'; 
                if(errorEl) errorEl.textContent = ''; 
            }
            async function loadSubject() {
                try {
                    const r = await fetch(apiUrl);
                    if (!r.ok) throw new Error('Error cargando asignatura');
                    const s = await r.json();
                    
                    document.getElementById('es_id').value = s.id ?? subjectId;
                    document.getElementById('es_name').value = s.name ?? s.title ?? '';
                    document.getElementById('es_desc').value = s.desc ?? '';
                    document.getElementById('es_long').value = s.description ?? s.long ?? '';
                    document.getElementById('es_credits').value = s.credits ?? 0;
                    document.getElementById('es_prof').value = s.professor ?? s.prof ?? '';
                    document.getElementById('es_sched').value = s.schedule ?? s.sched ?? '';
                    try {
                        const color = s.color && s.color.startsWith('#') ? s.color : '#6366f1';
                        document.getElementById('es_color').value = color;
                    } catch {}
                    
                    currentIconPath = s.icon || null;
                    if (currentIconWrap) {
                        currentIconWrap.innerHTML = currentIconPath ? 
                            '<small>Icono actual:</small><div style="width:48px; height:48px; border-radius:8px; overflow:hidden; margin-top:6px"><img src="' + currentIconPath + '" style="width:100%;height:100%;object-fit:contain" /></div>' : '';
                    }
                } catch (e) {
                    if (errorEl) errorEl.textContent = e.message || 'No se pudo cargar la asignatura';
                }
            }

            async function uploadIconIfNeeded() {
                const file = iconFileInput && iconFileInput.files && iconFileInput.files[0];
                if (!file) return null;
                const fd = new FormData();
                fd.append('icon', file);
                const r = await fetch('/uploadIcon', { method: 'POST', body: fd });
                if (!r.ok) throw new Error('Error subiendo icono');
                const j = await r.json();
                return j.path || j.url || j.location || null;
            }

            if (editBtn) {
                editBtn.addEventListener('click', async () => {
                    await loadSubject();
                    openModal();
                });
            }

            if (closeButtons) {
                closeButtons.forEach(b => b.addEventListener('click', closeModal));
            }

            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (errorEl) errorEl.textContent = '';
                    try {
                        let newIconPath = null;
                        if (iconFileInput && iconFileInput.files && iconFileInput.files.length > 0) {
                            newIconPath = await uploadIconIfNeeded();
                        }
                        const subjectData = {
                            id: subjectId,
                            name: document.getElementById('es_name').value.trim(),
                            desc: document.getElementById('es_desc').value.trim(),
                            description: document.getElementById('es_long').value.trim(),
                            credits: Number(document.getElementById('es_credits').value || 0),
                            professor: document.getElementById('es_prof').value.trim(),
                            schedule: document.getElementById('es_sched').value.trim(),
                            color: document.getElementById('es_color').value
                        };
                        if (newIconPath) subjectData.icon = newIconPath;
                        else if (currentIconPath) subjectData.icon = currentIconPath;

                        const r = await fetch('/subject/' + encodeURIComponent(subjectId) + '/modify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ subject: subjectData })
                        });
                        const data = await r.json().catch(() => null);
                                                if (r.ok && (!data || data.code === 0 || data.code === undefined)) {
                            window.location.reload();
                        } else {
                            if (errorEl) errorEl.textContent = (data && (data.message || data.error)) || ('Error al guardar (code=' + (data && data.code) + ')');
                        }
                    } catch (err) {
                        if (errorEl) errorEl.textContent = err.message || 'Error de red';
                    }
                });
            }

            // --- GESTIONAR ALUMNOS ---
            const manageBtn = document.getElementById('manageStudentsBtn');
            const studentsModal = document.getElementById('studentsModal');
            const studentsList = document.getElementById('studentsList');
            const btnAddStudent = document.getElementById('btnAddStudent');
            const inputStudent = document.getElementById('newStudentEmail');

            async function loadStudents() {
                const r = await fetch(`/api/subjects/${subjectId}/students`);
                const students = await r.json();
                studentsList.innerHTML = '';
                students.forEach(email => {
                    const li = document.createElement('li');
                    li.style.cssText = "display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid var(--border);";
                    li.innerHTML = `
                        <span>${email}</span>
                        <button class="btn-delete-student" style="color:red; background:none; border:none; cursor:pointer;">‚úï</button>
                    `;
                    li.querySelector('button').onclick = () => removeStudent(email);
                    studentsList.appendChild(li);
                });
            }

            async function addStudent() {
                const email = inputStudent.value.trim();
                if(!email) return;
                await fetch(`/api/subjects/${subjectId}/students`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email })
                });
                inputStudent.value = '';
                loadStudents();
            }

            async function removeStudent(email) {
                if(!confirm('¬øEliminar a ' + email + '?')) return;
                await fetch(`/api/subjects/${subjectId}/students/${email}`, { method: 'DELETE' });
                loadStudents();
            }

            if(manageBtn) {
                manageBtn.addEventListener('click', () => {
                    if(studentsModal) studentsModal.style.display = 'grid';
                    loadStudents();
                });
            }
            if(btnAddStudent) btnAddStudent.addEventListener('click', addStudent);

            // Cierre de modales (gen√©rico)
            const allCloseBtns = document.querySelectorAll('[data-close]');
            allCloseBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const selector = btn.getAttribute('data-close');
                    const m = document.querySelector(selector);
                    if(m) m.style.display = 'none';
                    if(errorEl) errorEl.textContent = '';
                });
            });

        })();
        </script>
    </body>
</html>